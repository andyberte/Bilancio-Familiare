<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestione Bilancio Familiare</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh; 
            padding: 20px; 
        }
        .container { max-width: 1400px; margin: 0 auto; }
        
        /* HEADER */
        .header { 
            background: white; padding: 30px; border-radius: 15px; 
            box-shadow: 0 10px 30px rgba(0,0,0,0.2); margin-bottom: 30px; 
            text-align: center; 
        }
        .header h1 { color: #667eea; font-size: 2.5em; margin-bottom: 10px; }
        .header p { color: #666; font-size: 1.1em; }
        
        /* NAVIGATION BAR */
        .nav-section { 
            display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); 
            gap: 15px; margin-bottom: 30px; 
        }
        .nav-btn { 
            background: white; border: none; padding: 20px; border-radius: 12px; 
            cursor: pointer; font-size: 1em; font-weight: 600; transition: all 0.3s ease; 
            box-shadow: 0 5px 15px rgba(0,0,0,0.1); color: #667eea; 
        }
        .nav-btn:hover { transform: translateY(-5px); box-shadow: 0 10px 25px rgba(0,0,0,0.2); }
        .nav-btn.active, .nav-btn.active:hover { 
            background: #667eea; color: white; 
        }
        
        /* MAIN CONTENT */
        .content { 
            background: white; padding: 40px; border-radius: 15px; 
            box-shadow: 0 10px 30px rgba(0,0,0,0.2); display: none; 
        }
        .content.active { display: block; }
        
        /* CARDS GRID */
        .stats-grid { 
            display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); 
            gap: 20px; margin-bottom: 30px; 
        }
        .stat-card { 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; 
            padding: 25px; border-radius: 12px; text-align: center; 
            box-shadow: 0 5px 15px rgba(0,0,0,0.1); 
        }
        .stat-card h3 { font-size: 0.9em; margin-bottom: 10px; opacity: 0.9; }
        .stat-card .value { font-size: 2.5em; font-weight: bold; }
        
        /* FORM STYLES */
        .form-group { margin-bottom: 15px; }
        label { display: block; margin-bottom: 5px; color: #333; font-weight: 600; }
        input, select, textarea { 
            width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; 
            font-size: 1em; transition: border-color 0.3s; 
        }
        input:focus, select:focus, textarea:focus { 
            outline: none; border-color: #667eea; 
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1); 
        }
        .form-row { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; }
        
        /* BUTTON STYLES */
        .btn { 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; 
            border: none; padding: 12px 30px; border-radius: 8px; cursor: pointer; 
            font-weight: 600; transition: all 0.3s; font-size: 1em; 
        }
        .btn:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4); }
        .btn-secondary { background: #f0f0f0; color: #667eea; }
        .btn-secondary:hover { background: #e0e0e0; }
        
        /* TABLE STYLES */
        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        thead { background: #f5f5f5; }
        th { padding: 15px; text-align: left; color: #667eea; font-weight: 600; border-bottom: 2px solid #667eea; }
        td { padding: 12px 15px; border-bottom: 1px solid #e0e0e0; }
        tr:hover { background: #f9f9f9; }
        
        .badge { 
            display: inline-block; padding: 5px 12px; border-radius: 20px; 
            font-size: 0.85em; font-weight: 600; 
        }
        .badge-entrata { background: #d4edda; color: #155724; }
        .badge-uscita { background: #f8d7da; color: #721c24; }
        
        /* ANALYSIS SECTION */
        .analysis-grid { 
            display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); 
            gap: 20px; margin-top: 20px; 
        }
        .analysis-card { 
            background: #f9f9f9; padding: 20px; border-radius: 10px; 
            border-left: 4px solid #667eea; 
        }
        .analysis-card h4 { color: #667eea; margin-bottom: 15px; }
        .analysis-item { 
            display: flex; justify-content: space-between; padding: 10px 0; 
            border-bottom: 1px solid #e0e0e0; 
        }
        .analysis-item:last-child { border-bottom: none; }
        
        /* RESPONSIVE */
        @media (max-width: 768px) {
            .header h1 { font-size: 1.8em; }
            .nav-section { grid-template-columns: 1fr 1fr; }
            .content { padding: 20px; }
            .stats-grid, .form-row { grid-template-columns: 1fr; }
        }
        
        .delete-btn { 
            background: #f44336; color: white; border: none; padding: 5px 10px; 
            border-radius: 5px; cursor: pointer; font-size: 0.85em; 
        }
        .delete-btn:hover { background: #d32f2f; }
        
        .alert { 
            padding: 15px; border-radius: 8px; margin-bottom: 20px; 
        }
        .alert-success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .alert-error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
    </style>
</head>
<body>
    <div class="container">
        <!-- HEADER -->
        <div class="header">
            <h1>üí∞ Gestione Bilancio Familiare</h1>
            <p>Traccia le tue entrate e uscite in modo semplice e intuitivo</p>
        </div>
        
        <!-- NAVIGATION -->
        <div class="nav-section">
            <button class="nav-btn active" onclick="showSection('dashboard')">üìä Dashboard</button>
            <button class="nav-btn" onclick="showSection('movimenti')">‚ûï Registra Movimento</button>
            <button class="nav-btn" onclick="showSection('storico')">üìã Storico</button>
            <button class="nav-btn" onclick="showSection('analisi')">üìà Analisi</button>
            <button class="nav-btn" onclick="showSection('conti')">üí≥ Conti e Carte</button>
            <button class="nav-btn" onclick="showSection('categorie')">üè∑Ô∏è Categorie</button>
            <button class="nav-btn" onclick="salvaSuGoogle()">üíæ Salva su Google Drive</button>
            <button class="nav-btn" onclick="caricaDaGoogle()">üì• Carica da Google Drive</button>
        </div>
        
        <!-- DASHBOARD -->
        <div id="dashboard" class="content active">
            <h2>üìä Dashboard</h2>
            <div class="stats-grid">
                <div class="stat-card">
                    <h3>Entrate Totali</h3>
                    <div class="value" id="totalEntrate">‚Ç¨0.00</div>
                </div>
                <div class="stat-card">
                    <h3>Uscite Totali</h3>
                    <div class="value" id="totalUscite">‚Ç¨0.00</div>
                </div>
                <div class="stat-card">
                    <h3>Bilancio Netto</h3>
                    <div class="value" id="bilancioNetto">‚Ç¨0.00</div>
                </div>
            </div>
            <h3 style="margin-top: 30px; color: #667eea; margin-bottom: 15px;">Ultimi Movimenti</h3>
            <table>
                <thead>
                    <tr>
                        <th>Data</th><th>Categoria</th><th>Descrizione</th><th>Metodo</th><th>Importo</th><th>Tipo</th>
                    </tr>
                </thead>
                <tbody id="ultimiMovimenti">
                    <tr><td colspan="6" style="text-align: center; color: #999;">Nessun movimento registrato</td></tr>
                </tbody>
            </table>
        </div>
        
        <!-- REGISTRA MOVIMENTO -->
        <div id="movimenti" class="content">
            <h2>‚ûï Registra Nuovo Movimento</h2>
            <div id="message"></div>
            <form onsubmit="registraMovimento(event)">
                <div class="form-row">
                    <div class="form-group">
                        <label for="data">üìÖ Data</label>
                        <input type="date" id="data" required>
                    </div>
                    <div class="form-group">
                        <label for="categoria">üè∑Ô∏è Categoria</label>
                        <select id="categoria" required>
                            <option value="">Seleziona categoria...</option>
                        </select>
                    </div>
                </div>
                <div class="form-group">
                    <label for="descrizione">üìù Descrizione</label>
                    <input type="text" id="descrizione" placeholder="Descrivi il movimento" required>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="metodo">üí≥ Metodo Pagamento</label>
                        <select id="metodo" required>
                            <option value="">Seleziona metodo...</option>
                            <option value="Contanti">Contanti</option>
                            <option value="Conto Corrente">Conto Corrente</option>
                            <option value="Carta Debito">Carta Debito</option>
                            <option value="Carta Credito">Carta Credito</option>
                            <option value="Bonifico">Bonifico</option>
                            <option value="Assegno">Assegno</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="conto">üè¶ Conto/Carta</label>
                        <select id="conto" required>
                            <option value="">Seleziona conto...</option>
                        </select>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="importoEntrata">üí∞ Entrata</label>
                        <input type="number" id="importoEntrata" placeholder="0.00" min="0" step="0.01">
                    </div>
                    <div class="form-group">
                        <label for="importoUscita">üí∏ Uscita</label>
                        <input type="number" id="importoUscita" placeholder="0.00" min="0" step="0.01">
                    </div>
                </div>
                <button type="submit" class="btn">‚úÖ Registra Movimento</button>
            </form>
        </div>
        
        <!-- STORICO MOVIMENTI -->
        <div id="storico" class="content">
            <h2>üìã Storico Movimenti</h2>
            <div class="form-group" style="margin-bottom: 20px;">
                <label for="filtroCategoria">üîç Filtra per categoria</label>
                <select id="filtroCategoria" onchange="filtraMovimenti()">
                    <option value="">Tutte le categorie</option>
                </select>
            </div>
            <table>
                <thead>
                    <tr>
                        <th>Data</th><th>Categoria</th><th>Descrizione</th><th>Metodo</th>
                        <th>Conto</th><th>Importo</th><th>Tipo</th><th>Azioni</th>
                    </tr>
                </thead>
                <tbody id="tabellaMovimenti">
                    <tr><td colspan="8" style="text-align: center; color: #999;">Nessun movimento registrato</td></tr>
                </tbody>
            </table>
        </div>
        
        <!-- ANALISI -->
        <div id="analisi" class="content">
            <h2>üìà Analisi Finanziaria</h2>
            <div class="analysis-grid">
                <div class="analysis-card">
                    <h4>üìä Riepilogo Mensile</h4>
                    <div class="analysis-item">
                        <span>Entrate Totali</span>
                        <strong id="analisiEntrate">‚Ç¨0.00</strong>
                    </div>
                    <div class="analysis-item">
                        <span>Uscite Totali</span>
                        <strong id="analisiUscite">‚Ç¨0.00</strong>
                    </div>
                    <div class="analysis-item">
                        <span>Bilancio Netto</span>
                        <strong id="analisiBilancio">‚Ç¨0.00</strong>
                    </div>
                </div>
                <div class="analysis-card">
                    <h4>üí∏ Spese per Categoria</h4>
                    <div id="speseCategoriaList"></div>
                </div>
                <div class="analysis-card">
                    <h4>üí≥ Spese per Metodo Pagamento</h4>
                    <div id="spesePagamentoList"></div>
                </div>
            </div>
        </div>
        
        <!-- CONTI E CARTE -->
        <div id="conti" class="content">
            <h2>üí≥ Conti e Carte</h2>
            <h3 style="margin-top: 20px; margin-bottom: 15px;">Aggiungi nuovo conto/carta</h3>
            <form onsubmit="registraConto(event)">
                <div class="form-row">
                    <div class="form-group">
                        <label for="nomeConto">üè¶ Nome Conto/Carta</label>
                        <input type="text" id="nomeConto" placeholder="Es. Conto Corrente Principale" required>
                    </div>
                    <div class="form-group">
                        <label for="tipoConto">üìã Tipo</label>
                        <select id="tipoConto" required>
                            <option value="">Seleziona tipo...</option>
                            <option value="Conto Corrente">Conto Corrente</option>
                            <option value="Carta Debito">Carta Debito</option>
                            <option value="Carta Credito">Carta Credito</option>
                            <option value="Contanti">Contanti</option>
                        </select>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="banca">üè¢ Banca/Istituto</label>
                        <input type="text" id="banca" placeholder="Es. Banca XYZ">
                    </div>
                    <div class="form-group">
                        <label for="saldoIniziale">üí∞ Saldo Iniziale</label>
                        <input type="number" id="saldoIniziale" placeholder="0.00" min="0" step="0.01">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="limiteCredito">üí≥ Limite Credito (solo carte credito)</label>
                        <input type="number" id="limiteCredito" placeholder="0.00" min="0" step="0.01">
                    </div>
                    <div class="form-group">
                        <label for="scadenzaCarta">üìÖ Scadenza Carta (MM/AAAA)</label>
                        <input type="text" id="scadenzaCarta" placeholder="Es. 12/2027">
                    </div>
                </div>
                <button type="submit" class="btn">‚ûï Aggiungi Conto/Carta</button>
            </form>
            
            <h3 style="margin-top: 40px; margin-bottom: 15px;">Conti e Carte Registrati</h3>
            <table>
                <thead>
                    <tr>
                        <th>Nome</th><th>Tipo</th><th>Banca</th><th>Saldo (‚Ç¨)</th>
                        <th>Limite Credito</th><th>Scadenza</th><th>Azioni</th>
                    </tr>
                </thead>
                <tbody id="tabellaConti">
                    <tr><td colspan="7" style="text-align: center; color: #999;">Nessun conto registrato</td></tr>
                </tbody>
            </table>
        </div>
        
        <!-- CATEGORIE -->
        <div id="categorie" class="content">
            <h2>üè∑Ô∏è Gestisci Categorie</h2>
            <h3 style="margin-top: 20px; margin-bottom: 15px;">Aggiungi nuova categoria</h3>
            <form onsubmit="registraCategoria(event)">
                <div class="form-row">
                    <div class="form-group">
                        <label for="nomeCategoria">üè∑Ô∏è Nome Categoria</label>
                        <input type="text" id="nomeCategoria" placeholder="Es. Cibo" required>
                    </div>
                    <div class="form-group">
                        <label for="tipoCategoria">üìã Tipo</label>
                        <select id="tipoCategoria" required>
                            <option value="">Seleziona tipo...</option>
                            <option value="Entrata">Entrata üí∞</option>
                            <option value="Uscita">Uscita üí∏</option>
                        </select>
                    </div>
                </div>
                <div class="form-group">
                    <label for="descCategoria">üìù Descrizione</label>
                    <textarea id="descCategoria" placeholder="Descrizione della categoria" rows="3"></textarea>
                </div>
                <button type="submit" class="btn">‚ûï Aggiungi Categoria</button>
            </form>
            
            <h3 style="margin-top: 40px; margin-bottom: 15px;">Categorie Disponibili</h3>
            <table>
                <thead>
                    <tr><th>Categoria</th><th>Tipo</th><th>Descrizione</th><th>Azioni</th></tr>
                </thead>
                <tbody id="tabellaCategorie"></tbody>
            </table>
        </div>
    </div>

    <script>
        // URL del tuo script Google Apps Script
        const GOOGLE_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbyZokcunmcBvoTKlqZTV6S673KvjA6APDswC8GMS20kV_3_r6C09myQmWMJ2biLFIQ/exec';

        // DATI IN MEMORIA
        let movimenti = JSON.parse(localStorage.getItem('movimenti')) || [];
        let categorie = JSON.parse(localStorage.getItem('categorie')) || [
            { id: 1, nome: "Stipendio", tipo: "Entrata", descrizione: "Reddito principale" },
            { id: 2, nome: "Bonus", tipo: "Entrata", descrizione: "Premi e bonus" },
            { id: 3, nome: "Rendite", tipo: "Entrata", descrizione: "Interessi e dividendi" },
            { id: 4, nome: "Affitto", tipo: "Uscita", descrizione: "Canone affitto/mutuo" },
            { id: 5, nome: "Utilities", tipo: "Uscita", descrizione: "Luce, gas, acqua" },
            { id: 6, nome: "Spesa", tipo: "Uscita", descrizione: "Alimentari e drogheria" },
            { id: 7, nome: "Trasporti", tipo: "Uscita", descrizione: "Benzina, auto, mezzi" },
            { id: 8, nome: "Salute", tipo: "Uscita", descrizione: "Farmaci, medico" },
            { id: 9, nome: "Istruzione", tipo: "Uscita", descrizione: "Corsi e libri" },
            { id: 10, nome: "Intrattenimento", tipo: "Uscita", descrizione: "Cinema, cene, hobby" },
            { id: 11, nome: "Abbigliamento", tipo: "Uscita", descrizione: "Vestiti e scarpe" },
            { id: 12, nome: "Casa", tipo: "Uscita", descrizione: "Arredamento e manutenzione" },
            { id: 13, nome: "Assicurazioni", tipo: "Uscita", descrizione: "Polizze varie" },
            { id: 14, nome: "Altro", tipo: "Uscita", descrizione: "Voci non catalogate" }
        ];
        let conti = JSON.parse(localStorage.getItem('conti')) || [
            { id: 1, nome: "Conto Corrente Principale", tipo: "Conto Corrente", banca: "Banca XYZ", saldo: 0, limite: 0, scadenza: "" },
            { id: 2, nome: "Contanti", tipo: "Contanti", banca: "", saldo: 0, limite: 0, scadenza: "" }
        ];

        // Funzione per salvare i dati in localStorage
        function salvaDati() {
            localStorage.setItem('movimenti', JSON.stringify(movimenti));
            localStorage.setItem('categorie', JSON.stringify(categorie));
            localStorage.setItem('conti', JSON.stringify(conti));
        }

        // Funzione per salvare su Google Drive
        async function salvaSuGoogle() {
            const data = {
                movimenti: movimenti,
                categorie: categorie,
                conti: conti
            };
            try {
                await fetch(GOOGLE_SCRIPT_URL, {
                    method: 'POST',
                    body: JSON.stringify(data),
                    headers: { 'Content-Type': 'application/json' }
                });
                alert('Dati salvati su Google Drive!');
            } catch (error) {
                alert('Errore nel salvataggio su Google Drive');
            }
        }

        // Funzione per caricare da Google Drive
        async function caricaDaGoogle() {
            try {
                const response = await fetch(GOOGLE_SCRIPT_URL);
                const data = await response.json();
                movimenti = data.movimenti || [];
                categorie = data.categorie || [];
                conti = data.conti || [];
                aggiornaDashboard();
                aggiornaStorico();
                aggiornaAnalisi();
                aggiornaConti();
                aggiornaCategorie();
                salvaDati();
                alert('Dati caricati da Google Drive!');
            } catch (error) {
                alert('Errore nel caricamento da Google Drive');
            }
        }

        // FUNZIONI PRINCIPALI
        function showSection(sectionId) {
            document.querySelectorAll('.content').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.nav-btn').forEach(el => el.classList.remove('active'));
            document.getElementById(sectionId).classList.add('active');
            event.target.classList.add('active');
            if (sectionId === 'dashboard') aggiornaDashboard();
            else if (sectionId === 'storico') aggiornaStorico();
            else if (sectionId === 'analisi') aggiornaAnalisi();
            else if (sectionId === 'conti') aggiornaConti();
            else if (sectionId === 'categorie') aggiornaCategorie();
            aggiornaSelectCategorie();
        }

        function registraMovimento(event) {
            event.preventDefault();
            const data = document.getElementById('data').value;
            const categoria = document.getElementById('categoria').value;
            const descrizione = document.getElementById('descrizione').value;
            const metodo = document.getElementById('metodo').value;
            const conto = document.getElementById('conto').value;
            const entrata = parseFloat(document.getElementById('importoEntrata').value) || 0;
            const uscita = parseFloat(document.getElementById('importoUscita').value) || 0;
            if (!entrata && !uscita) {
                mostraMessaggio('Inserisci SOLO entrata oppure SOLO uscita', 'error');
                return;
            }
            movimenti.push({
                id: Date.now(),
                data: data,
                categoria: categoria,
                descrizione: descrizione,
                metodo: metodo,
                conto: conto,
                entrata: entrata,
                uscita: uscita,
                tipo: entrata > 0 ? "Entrata" : "Uscita"
            });
            mostraMessaggio("Movimento registrato con successo!", "success");
            document.querySelector("form").reset();
            document.getElementById("data").valueAsDate = new Date();
            aggiornaSelectCategorie();
            setTimeout(() => document.getElementById("message").innerHTML = "", 3000);
            salvaDati();
            salvaSuGoogle();
        }

        function aggiornaSelectCategorie() {
            const selectCat = document.getElementById('categoria');
            const selectConti = document.getElementById('conto');
            const filtro = document.getElementById('filtroCategoria');
            selectCat.innerHTML = '<option value="">Seleziona categoria...</option>';
            categorie.forEach(cat => {
                selectCat.innerHTML += `<option value="${cat.nome}">${cat.nome}</option>`;
            });
            selectConti.innerHTML = '<option value="">Seleziona conto...</option>';
            conti.forEach(conto => {
                selectConti.innerHTML += `<option value="${conto.nome}">${conto.nome}</option>`;
            });
            if (filtro) {
                filtro.innerHTML = '<option value="">Tutte le categorie</option>';
                categorie.forEach(cat => {
                    filtro.innerHTML += `<option value="${cat.nome}">${cat.nome}</option>`;
                });
            }
        }

        function aggiornaDashboard() {
            const totalEntrate = movimenti.reduce((sum, m) => sum + m.entrata, 0);
            const totalUscite = movimenti.reduce((sum, m) => sum + m.uscita, 0);
            const bilancio = totalEntrate - totalUscite;
            document.getElementById('totalEntrate').innerHTML = totalEntrate.toFixed(2);
            document.getElementById('totalUscite').innerHTML = totalUscite.toFixed(2);
            document.getElementById('bilancioNetto').innerHTML = bilancio.toFixed(2);
            const ultimi = movimenti.slice(-5).reverse();
            const tbody = document.getElementById('ultimiMovimenti');
            tbody.innerHTML = ultimi.length ? ultimi.map(m => `
                <tr>
                    <td>${m.data}</td>
                    <td>${m.categoria}</td>
                    <td>${m.descrizione}</td>
                    <td>${m.metodo}</td>
                    <td><span class="badge ${m.tipo === 'Entrata' ? 'badge-entrata' : 'badge-uscita'}">${m.tipo === 'Entrata' ? '+' : '-'}${m.entrata > 0 ? m.entrata : m.uscita}</span></td>
                    <td><span class="badge ${m.tipo === 'Entrata' ? 'badge-entrata' : 'badge-uscita'}">${m.tipo}</span></td>
                </tr>
            `).join('') : '<tr><td colspan="6" style="text-align: center; color: #999;">Nessun movimento registrato</td></tr>';
        }

        function aggiornaStorico() {
            aggiornaSelectCategorie();
            mostraMovimenti(movimenti);
        }

        function aggiornaAnalisi() {
            const totalEntrate = movimenti.reduce((sum, m) => sum + m.entrata, 0);
            const totalUscite = movimenti.reduce((sum, m) => sum + m.uscita, 0);
            const bilancio = totalEntrate - totalUscite;
            document.getElementById('analisiEntrate').innerHTML = totalEntrate.toFixed(2);
            document.getElementById('analisiUscite').innerHTML = totalUscite.toFixed(2);
            document.getElementById('analisiBilancio').innerHTML = bilancio.toFixed(2);

            // Spese per categoria
            const spesePerCategoria = {};
            movimenti.forEach(m => {
                if (!spesePerCategoria[m.categoria]) spesePerCategoria[m.categoria] = 0;
                spesePerCategoria[m.categoria] += m.uscita;
            });
            const speseCatList = document.getElementById('speseCategoriaList');
            speseCatList.innerHTML = Object.entries(spesePerCategoria)
                .filter(([cat, amount]) => amount > 0)
                .map(([cat, amount]) => `<div class="analysis-item"><span>${cat}</span><strong>${amount.toFixed(2)}</strong></div>`)
                .join('');

            // Spese per metodo
            const spesePerMetodo = {};
            movimenti.forEach(m => {
                if (!spesePerMetodo[m.metodo]) spesePerMetodo[m.metodo] = 0;
                spesePerMetodo[m.metodo] += m.uscita;
            });
            const spesePagList = document.getElementById('spesePagamentoList');
            spesePagList.innerHTML = Object.entries(spesePerMetodo)
                .filter(([metodo, amount]) => amount > 0)
                .map(([metodo, amount]) => `<div class="analysis-item"><span>${metodo}</span><strong>${amount.toFixed(2)}</strong></div>`)
                .join('');
        }

        function mostraMovimenti(listaMovimenti) {
            const tbody = document.getElementById('tabellaMovimenti');
            tbody.innerHTML = listaMovimenti.length ? listaMovimenti.map(m => `
                <tr>
                    <td>${m.data}</td>
                    <td>${m.categoria}</td>
                    <td>${m.descrizione}</td>
                    <td>${m.metodo}</td>
                    <td>${m.conto}</td>
                    <td><span class="badge ${m.tipo === 'Entrata' ? 'badge-entrata' : 'badge-uscita'}">${m.tipo === 'Entrata' ? '+' : '-'}${m.entrata > 0 ? m.entrata : m.uscita}</span></td>
                    <td><span class="badge ${m.tipo === 'Entrata' ? 'badge-entrata' : 'badge-uscita'}">${m.tipo}</span></td>
                    <td><button class="delete-btn" onclick="eliminaMovimento(${m.id})">Elimina</button></td>
                </tr>
            `).join('') : '<tr><td colspan="8" style="text-align: center; color: #999;">Nessun movimento registrato</td></tr>';
        }

        function filtraMovimenti() {
            const categoria = document.getElementById('filtroCategoria').value;
            const filtrati = categoria ? movimenti.filter(m => m.categoria === categoria) : movimenti;
            mostraMovimenti(filtrati);
        }

        function eliminaMovimento(id) {
            if (confirm("Sei sicuro di voler eliminare questo movimento?")) {
                movimenti = movimenti.filter(m => m.id !== id);
                aggiornaStorico();
                aggiornaDashboard();
                salvaDati();
                salvaSuGoogle();
            }
        }

        function registraConto(event) {
            event.preventDefault();
            const nome = document.getElementById('nomeConto').value;
            const tipo = document.getElementById('tipoConto').value;
            const banca = document.getElementById('banca').value;
            const saldo = parseFloat(document.getElementById('saldoIniziale').value) || 0;
            const limite = parseFloat(document.getElementById('limiteCredito').value) || 0;
            const scadenza = document.getElementById('scadenzaCarta').value;
            conti.push({
                id: Date.now(),
                nome: nome,
                tipo: tipo,
                banca: banca,
                saldo: saldo,
                limite: limite,
                scadenza: scadenza
            });
            mostraMessaggio("Conto/Carta registrato con successo!", "success");
            document.querySelector('#conti form').reset();
            aggiornaSelectCategorie();
            aggiornaConti();
            setTimeout(() => document.getElementById("message").innerHTML = "", 3000);
            salvaDati();
            salvaSuGoogle();
        }

        function aggiornaConti() {
            const tbody = document.getElementById('tabellaConti');
            if (conti.length > 2) {
                tbody.innerHTML = conti.slice(2).map(c => `
                    <tr>
                        <td>${c.nome}</td>
                        <td>${c.tipo}</td>
                        <td>${c.banca}</td>
                        <td>${c.saldo.toFixed(2)}</td>
                        <td>${c.limite.toFixed(2)}</td>
                        <td>${c.scadenza}</td>
                        <td><button class="delete-btn" onclick="eliminaConto(${c.id})">Elimina</button></td>
                    </tr>
                `).join('');
            } else {
                tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; color: #999;">Nessun conto personalizzato registrato</td></tr>';
            }
        }

        function eliminaConto(id) {
            if (confirm("Sei sicuro di voler eliminare questo conto?")) {
                conti = conti.filter(c => c.id !== id);
                aggiornaConti();
                aggiornaSelectCategorie();
                salvaDati();
                salvaSuGoogle();
            }
        }

        function registraCategoria(event) {
            event.preventDefault();
            const nome = document.getElementById('nomeCategoria').value;
            const tipo = document.getElementById('tipoCategoria').value;
            const desc = document.getElementById('descCategoria').value;
            categorie.push({
                id: Date.now(),
                nome: nome,
                tipo: tipo,
                descrizione: desc
            });
            mostraMessaggio("Categoria registrata con successo!", "success");
            document.querySelector('#categorie form').reset();
            aggiornaCategorie();
            aggiornaSelectCategorie();
            setTimeout(() => document.getElementById("message").innerHTML = "", 3000);
            salvaDati();
            salvaSuGoogle();
        }

        function aggiornaCategorie() {
            const tbody = document.getElementById('tabellaCategorie');
            tbody.innerHTML = categorie.map(c => `
                <tr>
                    <td>${c.nome}</td>
                    <td><span class="badge ${c.tipo === 'Entrata' ? 'badge-entrata' : 'badge-uscita'}">${c.tipo}</span></td>
                    <td>${c.descrizione}</td>
                    <td><button class="delete-btn" onclick="eliminaCategoria(${c.id})">Elimina</button></td>
                </tr>
            `).join('');
        }

        function eliminaCategoria(id) {
            if (confirm("Sei sicuro di voler eliminare questa categoria?")) {
                categorie = categorie.filter(c => c.id !== id);
                aggiornaCategorie();
                aggiornaSelectCategorie();
                salvaDati();
                salvaSuGoogle();
            }
        }

        function mostraMessaggio(testo, tipo) {
            const msgDiv = document.getElementById("message");
            msgDiv.className = `alert alert-${tipo}`;
            msgDiv.innerHTML = testo;
        }

        // Inizializza
        aggiornaSelectCategorie();
        aggiornaCategorie();
        aggiornaConti();
        aggiornaDashboard();
        aggiornaStorico();
        aggiornaAnalisi();
    </script>
</body>
</html>
